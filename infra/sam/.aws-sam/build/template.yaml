AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Sushi Invoice backend on Lambda and API Gateway HTTP API.
Parameters:
  StageName:
    Type: String
    Default: $default
    Description: HTTP API stage name. Keep $default to avoid stage path prefixes.
  CorsAllowedOrigins:
    Type: CommaDelimitedList
    Default: http://localhost:5173
    Description: Comma-separated list of frontend origins allowed to call the API.
  UsersTableName:
    Type: String
    Description: Existing DynamoDB users table name.
  InvoicesTableName:
    Type: String
    Description: Existing DynamoDB invoices table name.
  JwtSecret:
    Type: String
    NoEcho: true
    Description: Secret used to sign JWTs.
  JwtExpire:
    Type: String
    Default: 24h
  OrderApiUrl:
    Type: String
    Default: http://3.25.80.104:49153
  CurrencyApiKey:
    Type: String
    Default: ''
    NoEcho: true
  PeppolApiUrl:
    Type: String
    Default: ''
  PeppolApiKey:
    Type: String
    Default: ''
    NoEcho: true
  PeppolSendEndpoint:
    Type: String
    Default: send
  PeppolStatusEndpoint:
    Type: String
    Default: status
  OpenAIApiKey:
    Type: String
    Default: ''
    NoEcho: true
  GoogleEmail:
    Type: String
    Default: ''
  GoogleAppPassword:
    Type: String
    Default: ''
    NoEcho: true
Globals:
  Function:
    Runtime: nodejs20.x
    Architectures:
    - x86_64
    MemorySize: 512
    Timeout: 29
    Tracing: Active
    Environment:
      Variables:
        NODE_ENV: production
        USE_LOCAL_DYNAMODB: 'false'
        SERVE_FRONTEND: 'false'
        DYNAMODB_USERS_TABLE:
          Ref: UsersTableName
        DYNAMODB_INVOICES_TABLE:
          Ref: InvoicesTableName
        JWT_SECRET:
          Ref: JwtSecret
        JWT_EXPIRE:
          Ref: JwtExpire
        ALLOWED_ORIGINS:
          Fn::Join:
          - ','
          - Ref: CorsAllowedOrigins
        CORS_ORIGIN:
          Fn::Join:
          - ','
          - Ref: CorsAllowedOrigins
        ORDER_API_URL:
          Ref: OrderApiUrl
        CURRENCY_API_KEY:
          Ref: CurrencyApiKey
        PEPPOL_API_URL:
          Ref: PeppolApiUrl
        PEPPOL_API_KEY:
          Ref: PeppolApiKey
        PEPPOL_SEND_ENDPOINT:
          Ref: PeppolSendEndpoint
        PEPPOL_STATUS_ENDPOINT:
          Ref: PeppolStatusEndpoint
        OPENAI_API_KEY:
          Ref: OpenAIApiKey
        GOOGLE_EMAIL:
          Ref: GoogleEmail
        GOOGLE_APP_PASSWORD:
          Ref: GoogleAppPassword
Resources:
  ApiGateway:
    Type: AWS::Serverless::HttpApi
    Properties:
      StageName:
        Ref: StageName
      CorsConfiguration:
        AllowOrigins:
          Ref: CorsAllowedOrigins
        AllowHeaders:
        - Content-Type
        - Authorization
        - token
        AllowMethods:
        - GET
        - POST
        - PUT
        - DELETE
        - OPTIONS
        AllowCredentials: true
  InvoiceApiFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: sushi-invoice-api
      CodeUri: InvoiceApiFunction
      Handler: lambda.handler
      Policies:
      - DynamoDBCrudPolicy:
          TableName:
            Ref: UsersTableName
      - DynamoDBCrudPolicy:
          TableName:
            Ref: InvoicesTableName
      Events:
        Root:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: ApiGateway
            Path: /
            Method: ANY
        Proxy:
          Type: HttpApi
          Properties:
            ApiId:
              Ref: ApiGateway
            Path: /{proxy+}
            Method: ANY
    Metadata:
      SamResourceId: InvoiceApiFunction
Outputs:
  ApiBaseUrl:
    Description: Base URL for the deployed API.
    Value:
      Fn::GetAtt:
      - ApiGateway
      - ApiEndpoint
  ApiFunctionName:
    Description: Lambda function name.
    Value:
      Ref: InvoiceApiFunction
